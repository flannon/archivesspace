//= require ajaxtree
//= require tree_renderers
//= require tree_toolbar
//= require tree_reorder_toolbar
//= require tree_resizer
//= require largetree
//= require largetree_dragdrop


(function (exports) {
    "use strict";

    var renderers = {
        resource: new ResourceRenderer(),
        digital_object: new DigitalObjectRenderer(),
        classification: new ClassificationRenderer(),
    };

    function Tree(datasource_url, tree_container, form_container, toolbar_container, root_uri, read_only, root_record_type) {
        var self = this;

        self.datasource = new TreeDataSource(datasource_url);

        var tree_renderer = renderers[root_record_type];

        self.toolbar_container = toolbar_container;
        self.toolbar_renderer = new TreeToolbarRenderer(self, toolbar_container);

        self.root_record_type = root_record_type;

        self.large_tree = new LargeTree(/* datasource */ self.datasource, 
                                        /* container  */ tree_container,
                                        /* root_uri   */ root_uri,
                                        /* read_only */  read_only,
                                        /* renderer */   tree_renderer,
                                        /* tree_loaded_callback */
                                        function() {
                                            self.ajax_tree = new AjaxTree(self, form_container);
                                            self.resizer = new TreeResizer(self, tree_container);
                                        },
                                        /* node_selected_callback */
                                        function(node, tree) {
                                            self.toolbar_renderer.render(node);
                                        });


        if (!read_only) {
            self.dragdrop = self.large_tree.addPlugin(new LargeTreeDragDrop(self.large_tree));
        }

        self.large_tree.setGeneralErrorHandler(function (failure_type) {
            if (failure_type === 'fetch_node_failed') {
                /* This can happen when the user was logged out behind the scenes. */
                $('#tree-unexpected-failure').slideDown();
            }
        });
    };


    Tree.prototype.current = function() {
        return $('.current', this.large_tree.elt);
    };


    Tree.prototype.enabledReorderMode = function() {
        $(this.large_tree.elt).addClass('drag-enabled');

        this.ajax_tree.hide_form();
        this.ajax_tree.disable_hash_change();
        $.scrollTo(0);
        this.resizer.maximize(DRAGDROP_HOTSPOT_HEIGHT);
        this.toolbar_renderer = new ReorderModeToolbarRenderer(this, this.toolbar_container);
        this.toolbar_renderer.render(this.current());
    };

    Tree.prototype.disableReorderMode = function() {
        $(this.large_tree.elt).removeClass('drag-enabled');

        this.ajax_tree.renable_hash_change();
        this.ajax_tree.show_form();
        this.resizer.reset();
        this.toolbar_renderer = new TreeToolbarRenderer(this, this.toolbar_container);
        this.toolbar_renderer.render(this.current());
    };

    Tree.prototype.isReorderModeEnabled = function() {
        return $(this.large_tree.elt).is('.drag-enabled');
    };


    exports.Tree = Tree;
}(window));
